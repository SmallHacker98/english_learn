<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Link English v4.6 (Full Integration)</title>
    
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦‰</text></svg>">
    <link rel="manifest" id="my-manifest">

    <style>
        /* --- Base Styles --- */
        :root {
            --primary: #3b82f6; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --subtext: #64748b;
            --border: #e2e8f0; --accent: #f59e0b; --danger: #ef4444; --success: #10b981;
            --cat-bus: #dbeafe; --cat-bus-t: #1e40af; --cat-day: #dcfce7; --cat-day-t: #166534;
            --cat-trv: #fce7f3; --cat-trv-t: #9d174d; --cat-toe: #ffedd5; --cat-toe-t: #9a3412;
            --status-done: #dcfce7; --status-done-t: #166534;
            --tab-active-bg: #eff6ff; --tab-active-t: #3b82f6;
        }
        [data-theme="dark"] {
            --primary: #60a5fa; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8;
            --border: #334155; --cat-bus: #1e3a8a; --cat-bus-t: #dbeafe; --cat-day: #14532d; --cat-day-t: #dcfce7;
            --cat-trv: #831843; --cat-trv-t: #fce7f3; --cat-toe: #7c2d12; --cat-toe-t: #ffedd5;
            --status-done: #064e3b; --status-done-t: #6ee7b7;
            --tab-active-bg: #1e293b; --tab-active-t: #60a5fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overscroll-behavior: none; -webkit-overflow-scrolling: touch; }        
        header { background-color: var(--card); border-bottom: 1px solid var(--border); padding: 0.8rem; display: flex; justify-content: space-between; align-items: center; padding-top: env(safe-area-inset-top); z-index: 10;}
        .app-title { font-weight: bold; font-size: 1.1rem; }
        .theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        .bottom-nav { display: flex; background: var(--card); border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index:10; }
        .nav-item { flex: 1; padding: 12px; text-align: center; font-size: 0.7rem; color: var(--subtext); cursor: pointer; border-top: 3px solid transparent; position: relative;}
        .nav-item.active { color: var(--primary); border-top-color: var(--primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }
        .nav-badge { position: absolute; top: 4px; right: calc(50% - 22px); background: var(--danger); color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; border: 2px solid var(--card); line-height: 1; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        main { flex: 1; overflow-y: auto; padding: 1rem; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        .card { background: var(--card); border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .btn { background-color: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 0.95rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; width: 100%; box-sizing: border-box; font-weight: 600; }
        .btn:active { opacity: 0.9; transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-accent { background-color: var(--accent); color: #fff; }

        .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; background: var(--card); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); }
        .list-content { flex: 1; }
        .list-summary { font-weight: bold; font-size: 1rem; margin-bottom: 5px; }
        .list-meta { display: flex; gap: 8px; align-items: center; font-size: 0.8rem; flex-wrap: wrap; }
        .cat-tag { padding: 2px 8px; border-radius: 10px; font-weight: 600; font-size: 0.75rem; }
        .level-tag { font-size: 0.7rem; padding: 1px 6px; border: 1px solid var(--border); border-radius: 4px; color: var(--subtext); }

        .lesson-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lesson-tabs { display: flex; background: var(--bg); padding: 4px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
        .l-tab { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--subtext); transition: 0.2s; font-size: 0.95rem; }
        .l-tab.active { background: var(--card); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .text-en { font-size: 1.2rem; line-height: 1.6; margin: 15px 0; white-space: pre-wrap; }
        .text-jp { color: var(--subtext); font-size: 0.95rem; margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
        .chunk-view { line-height: 2; font-size: 1.1rem; } .chunk-sep { color: var(--subtext); opacity: 0.3; margin: 0 4px; }
        
        .drill-card { border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
        .btn-mic { background: var(--bg); border: 1px solid var(--subtext); color: var(--text); }
        .btn-mic.listening { background: var(--danger); color: white; border-color: var(--danger); animation: pulse 1.5s infinite; }
        .score-box { margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 0.9rem; }
        .word-ok { color: var(--success); font-weight: bold; }
        .word-miss { color: var(--danger); text-decoration: line-through; opacity: 0.6; }

        input[type=range] { flex: 1; margin: 0 10px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-col { flex: 1; }
        label { font-size: 0.75rem; color: var(--subtext); font-weight: bold; display: block; margin-bottom: 3px; }
        textarea, input[type=text], input[type=number], select { width: 100%; padding: 8px; border-radius: 6px; background: var(--bg); color: var(--text); border: 1px solid var(--border); box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; color: white; }
        .modal-box { background: var(--card); color: var(--text); width: 100%; max-width: 500px; border-radius: 16px; padding: 25px; box-sizing: border-box; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .timer-bar-container { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 15px; margin-bottom: 15px; }
        .timer-bar { height: 100%; background: var(--danger); width: 100%; transition: width 0.1s linear; }
        .score-chip { display:inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left:5px;}
        .sc-good { background: var(--status-done); color: var(--status-done-t); }
        .sc-bad { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<header>
    <div class="app-title">Link English v4.6</div>
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
</header>

<main id="app-content"></main>

<div class="bottom-nav">
    <div class="nav-item active" id="nav-list" onclick="setMode('list')">
        <span class="nav-icon">ğŸ“‚</span>List
    </div>
    <div class="nav-item" id="nav-test" onclick="startTest()">
        <span class="nav-icon">ğŸ¯</span>Test
        <span id="test-badge" class="nav-badge hidden">0</span>
    </div>
    <div class="nav-item" id="nav-stats" onclick="setMode('stats')">
        <span class="nav-icon">ğŸ“Š</span>Stats
    </div>
    <div class="nav-item" id="nav-config" onclick="setMode('settings')">
        <span class="nav-icon">âš™ï¸</span>Config
    </div>
</div>

<div id="mode2-modal" class="modal-overlay hidden">
    <div class="modal-box" id="mode2-content"></div>
</div>

<script>
// --- PWA UPDATE DETECTION ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            // å®šæœŸãƒã‚§ãƒƒã‚¯ (1æ™‚é–“ã”ã¨)
            setInterval(() => { reg.update(); }, 60 * 60 * 1000);

            // â‘  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã®æ¤œçŸ¥
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateBanner();
                    }
                });
            });
        }).catch(err => console.log('SW registration failed: ', err));
    });

    // â‘¡ ã€è¿½åŠ ã€‘Androidå¯¾ç­–ï¼šè£å´ã§ã‚·ã‚¹ãƒ†ãƒ ãŒå¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸç¬é–“ã‚’æ¤œçŸ¥
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        showUpdateBanner();
    });
}

function showUpdateBanner() {
    // æ—¢ã«ãƒãƒŠãƒ¼ãŒå‡ºã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    if (document.getElementById('update-banner')) return;
    
    const banner = document.createElement('div');
    banner.id = 'update-banner';
    banner.innerHTML = `
        <div style="position:fixed; bottom:80px; left:20px; right:20px; background:var(--danger); color:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; z-index:9999; box-shadow:0 4px 15px rgba(0,0,0,0.3);">
            <span style="font-weight:bold; font-size: 0.9rem;">âœ¨ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™</span>
            <button onclick="window.location.reload()" style="background:white; color:var(--danger); border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer;">æ›´æ–°ã™ã‚‹</button>
        </div>
    `;
    document.body.appendChild(banner);
}

// --- CORE DATA & STATE ---
const manifest = { "name": "Link English", "short_name": "LinkEng", "start_url": ".", "display": "standalone", "background_color": "#f8fafc", "theme_color": "#3b82f6", "icons": [{ "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦‰</text></svg>", "sizes": "512x512", "type": "image/svg+xml" }] };
document.getElementById('my-manifest').setAttribute('href', 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest)));

let state = { 
    data: [], currentIndex: 0, mode: 'list', lessonTab: 'commute',
    theme: 'light', showText: false, selectedVoiceIndex: -1, voiceRate: 1.0, 
    isLooping: false, promptTopic: "Business", promptLevel: "Intermediate", promptQty: 3
};
let voices = [], recognition = null, silentAudio = null, audioCtx = null;
let m2 = { queue: [], currentIndex: 0, timerId: null, timeLeft: 10, isRecording: false, currentTarget: "", currentStatsObj: null };

// --- INITIALIZATION ---
function init() {
    const savedData = localStorage.getItem('le_data');
    state.data = savedData ? JSON.parse(savedData) : [];
    
    // Statsãƒ‘ãƒƒãƒ (å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚‚SRSç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä»˜ä¸)
    const patchStats = (item) => {
        if (!item.stats) item.stats = { last_score: null, result: null, interval: 0, next_review: 0, tested_in_m2: false };
        if (item.stats.tested_in_m2 === undefined) item.stats.tested_in_m2 = false;
    };
    state.data.forEach(d => { 
        if(!d.progress) d.progress = {listen:false, speak:false}; 
        patchStats(d.commute_content);
        if(d.home_content.drills) d.home_content.drills.forEach(patchStats);
    });

    const restore = (k, t) => { const v = localStorage.getItem(k); if(v) state[t] = (t==='theme' || t==='selectedVoiceIndex') ? v : parseFloat(v); };
    restore('le_theme', 'theme'); restore('le_voice_index', 'selectedVoiceIndex'); restore('le_voice_rate', 'voiceRate');
    
    if (state.theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    
    // ãƒã‚¤ã‚¯ã®äº‹å‰è¨±å¯
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => s.getTracks().forEach(t => t.stop())).catch(e => console.warn("Mic auth:", e));
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition(); 
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.continuous = false;
    }
    
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices(); 
    render();
}

function loadVoices() {
    voices = window.speechSynthesis.getVoices(); 
    if (state.selectedVoiceIndex === -1 && voices.length) {
        let idx = voices.findIndex(v => v.lang === "en-US");
        if (idx !== -1) state.selectedVoiceIndex = idx;
    }
}

function playBeep() {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
    osc.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15);
}

// --- BACKGROUND PLAYBACK HACK ---
function enableBackgroundPlayback() {
    if (!silentAudio) {
        const silentSrc = "data:audio/wav;base64,UklGRigAAABXQVZFRm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
        silentAudio = new Audio(silentSrc);
        silentAudio.loop = true;
    }
    silentAudio.play().catch(e => console.log("Silent audio blocked", e));
}

function disableBackgroundPlayback() {
    if (silentAudio) silentAudio.pause();
}

// --- NAVIGATION & UTILS ---
function setMode(m) { state.mode = m; stopAudio(); render(); }
function openLesson(i) { state.currentIndex = i; state.mode = 'lesson'; state.lessonTab = 'commute'; state.showText = false; stopAudio(); render(); }
function setLessonTab(t) { state.lessonTab = t; stopAudio(); render(); }
function toggleTheme() { state.theme = state.theme === 'light' ? 'dark' : 'light'; document.documentElement.setAttribute('data-theme', state.theme); localStorage.setItem('le_theme', state.theme); render(); }
function saveData() { localStorage.setItem('le_data', JSON.stringify(state.data)); }
function toggleProgress(type) { state.data[state.currentIndex].progress[type] = !state.data[state.currentIndex].progress[type]; saveData(); render(); }

// --- AUDIO LOGIC ---
function speak(txt, callback) { 
    window.speechSynthesis.cancel(); 
    const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; 
    if (voices[state.selectedVoiceIndex]) u.voice = voices[state.selectedVoiceIndex]; 
    u.rate = state.voiceRate;
    if (callback) u.onend = callback;
    window.speechSynthesis.speak(u); 
}

function stopAudio() { 
    state.isLooping = false; 
    window.speechSynthesis.cancel(); 
    disableBackgroundPlayback();
    render(); 
}

function toggleLoop() { 
    if (state.isLooping) {
        stopAudio();
    } else { 
        state.isLooping = true; 
        enableBackgroundPlayback();
        render(); 
        runRecursiveLoop();
    } 
}

function runRecursiveLoop() {
    if (!state.isLooping) return;
    const text = state.data[state.currentIndex].commute_content.english_text;
    speak(text, () => {
        if (state.isLooping) setTimeout(runRecursiveLoop, 3000);
    });
}

// --- SRS & SPEECH ANALYSIS ---
function updateSRS(statsObj, resultStr, score) {
    const now = Date.now(), DAY = 24 * 60 * 60 * 1000;
    let currentInterval = statsObj.interval || 0;
    
    if (resultStr === 'good') statsObj.interval = currentInterval === 0 ? 1 : currentInterval * 2;
    else if (resultStr === 'retry') statsObj.interval = 1;
    else statsObj.interval = 0;
    
    statsObj.next_review = now + (statsObj.interval * DAY);
    statsObj.result = resultStr;
    if (score !== undefined) statsObj.last_score = score;
}

function analyzeSpeech(target, input) {
    const clean = (s) => s.toLowerCase().replace(/[.,?!]/g, "").split(/\s+/).filter(x => x.length > 0);
    const tWords = clean(target), iWords = clean(input);
    let html = "", matched = 0;
    tWords.forEach(w => {
        if (iWords.includes(w)) { html += `<span class="word-ok">${w}</span> `; matched++; iWords.splice(iWords.indexOf(w), 1); }
        else html += `<span class="word-miss">${w}</span> `;
    });
    const score = tWords.length === 0 ? 0 : Math.round((matched / tWords.length) * 100);
    return { score, html: `<div style="font-weight:bold; color:${score===100?'var(--success)':'var(--danger)'}">Score: ${score}%</div>${html}` };
}

// --- MODE 1: SELF EVAL ---
function saveSelfEval(type, index, resultStr) {
    const d = state.data[state.currentIndex];
    let targetStats = (type === 'commute') ? d.commute_content.stats : d.home_content.drills[index].stats;
    updateSRS(targetStats, resultStr);
    saveData(); render();
}

function startDictation(target, resId, btnId) {
    if (!recognition) return alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒéŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™");
    const btn = document.getElementById(btnId); 
    const res = document.getElementById(resId);
    btn.classList.add('listening'); res.innerHTML = "Listening..."; res.classList.remove('hidden');
    
    try { recognition.start(); } catch(e) { console.warn(e); }
    
    recognition.onresult = (e) => {
        const input = e.results[0][0].transcript;
        const feedback = analyzeSpeech(target, input); 
        res.innerHTML = feedback.html;
        const ansId = resId.replace('res', 'ans');
        if (document.getElementById(ansId)) document.getElementById(ansId).classList.remove('hidden');
    };
    recognition.onend = () => btn.classList.remove('listening');
    recognition.onerror = (e) => {
        res.innerHTML = `<div style="color:var(--danger); font-size:0.8rem;">ã‚¨ãƒ©ãƒ¼: ${e.error}</div>`;
        btn.classList.remove('listening');
    };
}

// --- MODE 2: TENSION / SMART TEST LOGIC ---
function initMode2() {
    if(!recognition) return alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒéŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™");
    const d = state.data[state.currentIndex];
    m2.queue = [{ type: 'commute', jp: d.commute_content.japanese_translation, en: d.commute_content.english_text, obj: d.commute_content }];
    d.home_content.drills.forEach(drill => m2.queue.push({ type: 'drill', jp: drill.japanese, en: drill.english, obj: drill }));
    m2.queue.sort(() => Math.random() - 0.5);
    m2.currentIndex = 0;
    
    const modal = document.getElementById('mode2-modal');
    modal.classList.remove('hidden');
    document.getElementById('mode2-content').innerHTML = `
        <h2 style="margin-top:0;">ğŸ”¥ Tension Mode</h2>
        <p style="font-size:0.9rem; color:var(--subtext);">6 questions. Random order. 10 sec limit.<br>Speak immediately after the BEEP.</p>
        <button class="btn btn-danger-outline" style="margin-top:20px; font-size:1.2rem; border-width:2px; font-weight:bold;" onclick="startMode2Item()">Are you ready? [OK]</button>
        <br><button class="btn btn-outline" style="margin-top:15px; border:none;" onclick="closeMode2()">Cancel</button>
    `;
}

function startTest() {
    if(!recognition) return alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒéŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™");
    let dueItems = [];
    const now = Date.now();
    
    state.data.forEach((d) => {
        const check = (obj, jp, targetText) => {
            let st = obj.stats;
            if (st && st.tested_in_m2 && st.next_review <= now) {
                dueItems.push({ obj: obj, jp: jp, en: targetText, priority: st.next_review || 0 });
            }
        };
        check(d.commute_content, d.commute_content.japanese_translation, d.commute_content.english_text);
        if(d.home_content.drills) {
            d.home_content.drills.forEach(drill => check(drill, drill.japanese, drill.english));
        }
    });
    
    if (dueItems.length === 0) {
        alert("ğŸ‰ ä»Šã®ã¨ã“ã‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ï¼ˆâ€»Mode 2ã‚’å®Ÿæ–½ã—ãŸå•é¡ŒãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ï¼‰");
        setMode('list'); return;
    }
    
    dueItems.sort((a, b) => a.priority - b.priority);
    m2.queue = dueItems.slice(0, 10).sort(() => Math.random() - 0.5);
    m2.currentIndex = 0;
    
    document.getElementById('mode2-modal').classList.remove('hidden');
    document.getElementById('mode2-content').innerHTML = `
        <h2 style="margin-top:0;">ğŸ¯ Smart Test</h2>
        <p style="font-size:0.9rem; color:var(--subtext);">å¼±ç‚¹ã¨å¿˜å´æ›²ç·šã«åŸºã¥ã <b>${m2.queue.length}å•</b> ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚<br>10ç§’ä»¥å†…ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚</p>
        <button class="btn btn-success" style="margin-top:20px; font-size:1.2rem; border-width:2px; font-weight:bold;" onclick="startMode2Item()">Start Test [OK]</button>
        <br><button class="btn btn-outline" style="margin-top:15px; border:none;" onclick="closeMode2()">Cancel</button>
    `;
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('nav-test').classList.add('active');
    state.mode = 'test';
}

function closeMode2() {
    if(m2.isRecording) recognition.stop();
    clearTimeout(m2.timerId);
    document.getElementById('mode2-modal').classList.add('hidden');
    if(state.mode === 'test') setMode('list'); else render();
}

function startMode2Item() {
    if(m2.currentIndex >= m2.queue.length) {
        document.getElementById('mode2-content').innerHTML = `<h2>ğŸ‰ Complete!</h2><button class="btn" onclick="closeMode2()">Close</button>`;
        return;
    }
    const item = m2.queue[m2.currentIndex];
    m2.currentTarget = item.en; m2.currentStatsObj = item.obj; m2.timeLeft = 10;
    
    document.getElementById('mode2-content').innerHTML = `
        <div style="font-weight:bold; color:var(--danger); margin-bottom:10px;">Question ${m2.currentIndex + 1} / ${m2.queue.length}</div>
        <div style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">${item.jp}</div>
        <div style="font-size:2rem;">ğŸ™ï¸</div>
        <div class="timer-bar-container"><div class="timer-bar" id="m2-timer-bar"></div></div>
        <div id="m2-status" style="font-size:0.8rem; color:var(--danger); font-weight:bold;">Listening...</div>
    `;

    playBeep();
    setTimeout(() => {
        try { recognition.start(); m2.isRecording = true; } catch(e){}
        m2.timerId = setInterval(() => {
            m2.timeLeft -= 0.1;
            const bar = document.getElementById('m2-timer-bar');
            if(bar) bar.style.width = `${(m2.timeLeft / 10) * 100}%`;
            if (m2.timeLeft <= 0) {
                clearInterval(m2.timerId);
                if(m2.isRecording) recognition.stop();
                handleMode2Result(""); 
            }
        }, 100);
    }, 200);

    recognition.onresult = (e) => { clearInterval(m2.timerId); m2.isRecording = false; handleMode2Result(e.results[0][0].transcript); };
    recognition.onerror = (e) => { if(e.error === 'no-speech') { clearInterval(m2.timerId); handleMode2Result(""); } };
    recognition.onend = () => m2.isRecording = false;
}

function handleMode2Result(input) {
    clearInterval(m2.timerId);
    if(m2.isRecording) { recognition.stop(); m2.isRecording = false; }

    const isTimeout = (input.trim() === "");
    let feedback = "", score = 0, resStr = 'nogood';

    if (isTimeout) {
        feedback = `<div style="color:var(--danger); font-weight:bold; font-size:1.2rem; margin-bottom:10px;">â±ï¸ Time Out / Silence</div>`;
    } else {
        const analysis = analyzeSpeech(m2.currentTarget, input);
        score = analysis.score; feedback = analysis.html;
        if(score === 100) resStr = 'good'; else if(score >= 80) resStr = 'retry';
    }
    
    updateSRS(m2.currentStatsObj.stats, resStr, score);
    m2.currentStatsObj.stats.tested_in_m2 = true;
    saveData();

    document.getElementById('mode2-content').innerHTML = `
        <div style="font-weight:bold; color:var(--subtext); margin-bottom:5px;">Result (${m2.currentIndex + 1}/${m2.queue.length})</div>
        ${feedback}
        <div style="margin-top:15px; padding:10px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
            <div style="font-size:0.8rem; color:var(--subtext);">Target:</div>
            <div style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${m2.currentTarget}</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-outline" style="flex:1" onclick="closeMode2()">Stop</button>
            <button class="btn btn-danger-outline" style="flex:2; font-weight:bold;" onclick="m2.currentIndex++; startMode2Item()">Next â”</button>
        </div>
    `;
}

// --- RENDERING ---
function render() {
    const app = document.getElementById('app-content');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    if (state.mode === 'list') { document.getElementById('nav-list').classList.add('active'); renderList(app); }
    else if (state.mode === 'settings') { document.getElementById('nav-config').classList.add('active'); renderSettings(app); }
    else if (state.mode === 'lesson') { document.getElementById('nav-list').classList.add('active'); renderLesson(app); }
    else if (state.mode === 'stats') { document.getElementById('nav-stats').classList.add('active'); renderStats(app); }
    else if (state.mode === 'test') { document.getElementById('nav-test').classList.add('active'); }

    updateTestBadge();
}

function renderList(c) {
    if (state.data.length === 0) { c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--subtext)">No lessons.<br>Add some in Config!</div>'; return; }
    c.innerHTML = state.data.map((d, i) => {
        let dots = [d.commute_content, ...d.home_content.drills].map(item => {
            let color = '#e2e8f0';
            if (item.stats && item.stats.result === 'good') color = 'var(--success)';
            else if (item.stats && item.stats.result === 'retry') color = 'var(--accent)';
            else if (item.stats && item.stats.result === 'nogood') color = 'var(--danger)';
            return `<div style="width:10px; height:10px; border-radius:50%; background-color:${color};"></div>`;
        }).join('');
        return `
        <div class="list-item" onclick="openLesson(${i})">
            <div class="list-content">
                <div class="list-summary">${d.commute_content.summary}</div>
                <div class="list-meta" style="margin-bottom:8px;">
                    <span class="cat-tag cat-${d.category}">${d.category}</span>
                    <span class="level-tag">${d.level}</span>
                </div>
                <div style="display:flex; gap:15px; font-size:0.8rem;">
                    <div style="color:${d.progress.listen?'var(--success)':'var(--subtext)'}; font-weight:bold;">${d.progress.listen?'ğŸ§ âœ…':'ğŸ§ â¬œ'}</div>
                    <div style="display:flex; gap:4px; align-items:center;">ğŸ—£ï¸ ${dots}</div>
                </div>
            </div>
            <span>â€º</span>
        </div>`;
    }).join('');
}

function renderLesson(c) {
    const d = state.data[state.currentIndex];
    const isListen = state.lessonTab === 'commute';
    c.innerHTML = `
    <div class="lesson-header"><button class="btn-outline" onclick="setMode('list')" style="width:auto;padding:5px 10px;">â† Back</button><div style="font-weight:bold">${d.commute_content.summary}</div><div style="width:50px"></div></div>
    <div class="lesson-tabs"><div class="l-tab ${isListen?'active':''}" onclick="setLessonTab('commute')">ğŸ§ Commute</div><div class="l-tab ${!isListen?'active':''}" onclick="setLessonTab('practice')">ğŸ—£ï¸ Practice</div></div>
    <div class="card" style="padding:10px;">
        ${isListen ? renderListenContent(d) : renderSpeakContent(d)}
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:20px">
        <button class="btn-outline" style="width:45%" onclick="if(state.currentIndex>0) openLesson(state.currentIndex-1)" ${state.currentIndex===0?'disabled':''}>â† Prev</button>
        <button class="btn-outline" style="width:45%" onclick="if(state.currentIndex<state.data.length-1) openLesson(state.currentIndex+1)" ${state.currentIndex===state.data.length-1?'disabled':''}>Next â†’</button>
    </div>`;
}

function renderListenContent(d) {
    return `
    <div style="display:flex; gap:10px;">
        <button class="btn" onclick="speak('${d.commute_content.english_text.replace(/'/g, "\\'")}')">â–¶ï¸ Play</button>
        <button class="btn ${state.isLooping?'btn-accent':'btn-outline'}" onclick="toggleLoop()">${state.isLooping?'ğŸ” Stop':'ğŸ” Loop'}</button>
    </div>
    <div style="margin-top:15px; background:var(--bg); padding:10px; border-radius:8px; border:1px solid var(--border);">
        <div style="font-size:0.8rem; color:var(--subtext); font-weight:bold; margin-bottom:5px;">Speed: <span id="commute-rate-val">${Number(state.voiceRate).toFixed(1)}</span>x</div>
        <div style="display:flex; align-items:center;">
            <span style="font-size:1.2rem;">ğŸ¢</span>
            <input type="range" min="0.5" max="2.0" step="0.1" value="${state.voiceRate}" 
                oninput="state.voiceRate=parseFloat(this.value); localStorage.setItem('le_voice_rate', this.value); document.getElementById('commute-rate-val').innerText=Number(this.value).toFixed(1);" style="flex:1; margin:0 10px;">
            <span style="font-size:1.2rem;">ğŸ‡</span>
        </div>
    </div>
    <button class="btn ${d.progress.listen ? 'btn-success' : 'btn-outline'}" style="margin-top:15px; font-weight:bold;" onclick="toggleProgress('listen')">
        ${d.progress.listen ? 'âœ… Listen Done' : 'ğŸ§ Mark as Listen Done'}
    </button>
    <div id="txt-area" class="${state.showText?'':'hidden'}">
        <div class="text-en">${d.commute_content.english_text}</div>
        <div class="text-jp">${d.commute_content.japanese_translation}</div>
        <div class="chunk-view" style="margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
            ${d.commute_content.chunks.split('/').map(c=>`<span>${c}</span><span class="chunk-sep">/</span>`).join('')}
        </div>
    </div>
    <button class="btn-outline" style="margin-top:15px;" onclick="state.showText=!state.showText;render()">${state.showText?'ğŸ™ˆ Hide':'ğŸ‘ï¸ Show'} Text</button>`;
}

function renderSpeakContent(d) {
    let items = [{ type: 'commute', jp: d.commute_content.japanese_translation, en: d.commute_content.english_text, stats: d.commute_content.stats, idx: -1 }];
    d.home_content.drills.forEach((drill, i) => items.push({ type: 'drill', jp: drill.japanese, en: drill.english, stats: drill.stats, idx: i }));

    let html = `
    <button class="btn btn-danger-outline" style="width:100%; margin-bottom:15px; font-weight:bold; border-width:2px;" onclick="initMode2()">ğŸ”¥ Mode 2: Tension (Start)</button>
    <div style="font-size:0.8rem; color:var(--subtext); text-align:center; margin-bottom:15px;">Mode 1: My Pace (Self Eval)</div>
    `;

    items.forEach((item, i) => {
        let badge = item.stats.result === 'good' ? `<span class="score-chip sc-good">âœ… Good</span>` : 
                    item.stats.result === 'retry' ? `<span class="score-chip" style="background:var(--accent);color:white;">ğŸ”„ Retry</span>` : 
                    item.stats.result === 'nogood' ? `<span class="score-chip sc-bad">âŒ No Good</span>` : "";
        html += `
        <div class="drill-card">
            <div style="font-weight:bold; font-size:0.9rem; margin-bottom:8px;">${i+1}. ${item.jp} ${badge}</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn btn-mic" id="btn-m1-mic-${i}" onclick="startDictation('${item.en.replace(/'/g,"\\'")}', 'm1-res-${i}', 'btn-m1-mic-${i}')" style="flex:1">ğŸ™ï¸ Speak</button>
                <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('m1-ans-${i}').classList.remove('hidden')">ğŸ‘ï¸ Answer</button>
                <button class="btn btn-accent" onclick="speak('${item.en.replace(/'/g,"\\'")}')" style="width:50px; padding:0;">ğŸ”Š</button>
            </div>
            <div id="m1-res-${i}" class="hidden score-box"></div>
            <div id="m1-ans-${i}" class="hidden" style="margin-top:8px;">
                <div style="color:var(--primary); font-weight:bold; font-size:1.1rem; margin-bottom:10px;">${item.en}</div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-success" style="padding:6px; font-size:0.8rem;" onclick="saveSelfEval('${item.type}', ${item.idx}, 'good')">ğŸŸ¢ Good</button>
                    <button class="btn btn-accent" style="padding:6px; font-size:0.8rem;" onclick="saveSelfEval('${item.type}', ${item.idx}, 'retry')">ğŸŸ¡ Retry</button>
                    <button class="btn btn-danger-outline" style="padding:6px; font-size:0.8rem;" onclick="saveSelfEval('${item.type}', ${item.idx}, 'nogood')">ğŸ”´ No Good</button>
                </div>
            </div>
        </div>`;
    });
    return html;
}

function renderStats(c) {
    if (state.data.length === 0) { c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--subtext)">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }

    let total = 0, good = 0, retry = 0, nogood = 0, untested = 0;
    let weakPhrases = [];

    state.data.forEach((d, lessonIndex) => {
        const checkStat = (item, jp, en) => {
            total++;
            if (item && item.stats && item.stats.result) {
                const res = item.stats.result;
                if (res === 'good') good++;
                else if (res === 'retry') { retry++; weakPhrases.push({jp, en, res, lessonIndex}); }
                else if (res === 'nogood') { nogood++; weakPhrases.push({jp, en, res, lessonIndex}); }
            } else untested++;
        };
        checkStat(d.commute_content, d.commute_content.japanese_translation, d.commute_content.english_text);
        if(d.home_content.drills) d.home_content.drills.forEach(drill => checkStat(drill, drill.japanese, drill.english));
    });

    const goodPct = total === 0 ? 0 : Math.round((good / total) * 100);
    let html = `
    <h2 style="margin-top:0;">ğŸ“Š Learning Stats</h2>
    <div class="card" style="text-align:center; padding:20px;">
        <div style="font-size:3rem; font-weight:bold; color:var(--primary); line-height:1;">${goodPct}<span style="font-size:1.5rem">%</span></div>
        <div style="color:var(--subtext); font-size:0.9rem; margin-bottom:15px;">Mastery Rate (å®šç€ç‡)</div>
        <div style="display:flex; justify-content:space-around; align-items:center; background:var(--bg); padding:10px; border-radius:8px;">
            <div style="text-align:center;"><div style="font-size:1.2rem;">${good}</div><span class="score-chip sc-good">âœ… Good</span></div>
            <div style="text-align:center;"><div style="font-size:1.2rem;">${retry}</div><span class="score-chip" style="background:var(--accent);color:white;">ğŸ”„ Retry</span></div>
            <div style="text-align:center;"><div style="font-size:1.2rem;">${nogood}</div><span class="score-chip sc-bad">âŒ No Good</span></div>
        </div>
        <div style="font-size:0.8rem; color:var(--subtext); margin-top:10px;">æœªãƒ†ã‚¹ãƒˆ: ${untested} / å…¨${total}ãƒ•ãƒ¬ãƒ¼ã‚º</div>
    </div>`;

    if (weakPhrases.length > 0) {
        html += `<h3 style="margin-top:25px; border-bottom:2px solid var(--danger); display:inline-block;">ğŸ”¥ Needs Work (å¼±ç‚¹: ${weakPhrases.length})</h3>`;
        weakPhrases.reverse().slice(0, 10).forEach(wp => {
            const badge = wp.res === 'nogood' ? 'âŒ No Good' : 'ğŸ”„ Retry';
            html += `
            <div class="card" style="padding:15px; margin-bottom:10px; border-left:4px solid ${wp.res === 'nogood' ? 'var(--danger)' : 'var(--accent)'};" onclick="openLesson(${wp.lessonIndex})">
                <div style="font-size:0.8rem; color:var(--subtext); margin-bottom:5px;">${wp.jp}</div>
                <div style="font-weight:bold; font-size:1rem;">${wp.en}</div>
                <div style="margin-top:8px; font-size:0.8rem; font-weight:bold; color:${wp.res === 'nogood' ? 'var(--danger)' : 'var(--accent)'};">${badge}</div>
            </div>`;
        });
    } else if (good > 0) {
        html += `<div class="card" style="text-align:center; padding:30px; color:var(--success); font-weight:bold; font-size:1.1rem;">ğŸ‰ å¼±ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ï¼å®Œç’§ã§ã™ï¼</div>`;
    }
    c.innerHTML = html;
}

// --- CONFIG & PROMPT BUILDER ---
function updatePrompt() {
    const topic = document.getElementById('p-topic')?.value || "Business";
    const level = document.getElementById('p-level')?.value || "Intermediate";
    const qty = document.getElementById('p-qty')?.value || 3; 

    // ğŸ’¡ ä¿®æ­£ï¼šJSONãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã« // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œãªã„ã‚ˆã†ã«ã—ã€å¤–ã§æŒ‡ç¤ºã™ã‚‹
    const p = `ã‚ãªãŸã¯è‹±èªæ•™æä½œæˆã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®ä»•æ§˜ã§å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
## ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰
ãƒ†ãƒ¼ãƒ: ${topic}
ãƒ¬ãƒ™ãƒ«: ${level}
ä½œæˆæ•°: ${qty}ã‚»ãƒƒãƒˆï¼ˆ1ã‚»ãƒƒãƒˆã«ã¤ãã€ãƒ¡ã‚¤ãƒ³ä¾‹æ–‡1ã¤ï¼‹é–¢é€£ãƒ‰ãƒªãƒ«5ã¤ï¼‰
è‡ªç„¶ãªè¡¨ç¾ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ã€çµ¶å¯¾éµå®ˆãƒ«ãƒ¼ãƒ«ã€‘
1. å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã€‚è§£èª¬ã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯çµ¶å¯¾ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚
2. english_text ã¨ chunks ã®é€£çµçµæœã¯å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã€‚
3. å„ã‚»ãƒƒãƒˆã® "drills" é…åˆ—ã®ä¸­èº«ã¯å¿…ãš5å€‹ä½œæˆã™ã‚‹ã“ã¨ã€‚
4. ä»¥ä¸‹ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¿…ãš ${qty} ã‚»ãƒƒãƒˆåˆ†ç¹°ã‚Šè¿”ã—ãŸã€Œé…åˆ—ã€ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

\`\`\`json
[
  {
    "id": "gen_123456789", 
    "category": "${topic}",
    "level": "${level}",
    "progress": { "listen": false, "speak": false },
    "commute_content": { 
      "english_text": "...", "japanese_translation": "...", "chunks": "... / ...", "summary": "...", "vocabulary": [] 
    },
    "home_content": { 
      "pattern_focus": "...", "pattern_explanation": "...", 
      "drills": [
        {"japanese": "...", "english": "..."},
        {"japanese": "...", "english": "..."},
        {"japanese": "...", "english": "..."},
        {"japanese": "...", "english": "..."},
        {"japanese": "...", "english": "..."}
      ] 
    }
  }
]
\`\`\``;
    const area = document.getElementById('p-area');
    if (area) area.value = p;
}

function copyPrompt() { 
    updatePrompt(); 
    navigator.clipboard.writeText(document.getElementById('p-area').value).then(() => alert('Copied!')); 
}

function loadJsonData() { 
    try { 
        // ğŸ’¡ ä¿®æ­£ï¼šAIãŒå‡ºåŠ›ã—ãŸ ```json ã‚„ ``` ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·ã‚’è‡ªå‹•ã§å–ã‚Šé™¤ã
        let rawText = document.getElementById('data-input').value.trim();
        rawText = rawText.replace(/^```(json)?/im, '').replace(/```$/im, '').trim();

        const d = JSON.parse(rawText); 
        if (Array.isArray(d)) { 
            if (confirm('Add to existing?')) state.data = [...state.data, ...d]; else state.data = d; 
            saveData(); init(); 
            document.getElementById('data-input').value = ''; 
            setMode('list'); 
        } else {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) { 
        alert('Invalid JSON: ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\nä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); 
        console.error(e);
    } 
}

function renderSettings(c) {
    const voiceOpts = voices.map((v,i)=>`<option value="${i}" ${i==state.selectedVoiceIndex?'selected':''}>${v.name}</option>`).join('');
    c.innerHTML = `
    <div class="card">
        <h2>ğŸ¤– AI Prompt Builder v4.6</h2>
        <label>Topic</label>
        <input type="text" id="p-topic" value="${state.promptTopic}" oninput="updatePrompt()">
        
        <div class="form-row" style="margin-top:10px;">
            <div class="form-col">
                <label>Level</label>
                <select id="p-level" onchange="updatePrompt()">
                    <option>Intermediate</option>
                    <option>Advanced</option>
                    <option>Beginner</option>
                </select>
            </div>
            <div class="form-col" style="flex:0 0 70px;">
                <label>Qty</label>
                <input type="number" id="p-qty" value="${state.promptQty || 3}" oninput="updatePrompt()">
            </div>
        </div>
        
        <textarea id="p-area" style="font-size:0.6rem; height:120px; margin-top:15px;" readonly></textarea>
        <button class="btn btn-outline" onclick="copyPrompt()">ğŸ“‹ Copy Prompt</button>
    </div>
    
    <div class="card">
        <h2>Data & Voice</h2>
        <textarea id="data-input" placeholder="Paste JSON from Gemini here..."></textarea>
        <button class="btn" onclick="loadJsonData()" style="margin-top:10px;">Load Data</button>
        
        <div style="margin-top:20px;">
            <label>Voice</label>
            <select onchange="state.selectedVoiceIndex=this.value;localStorage.setItem('le_voice_index',this.value)">${voiceOpts}</select>
        </div>

        <div style="margin-top:20px;">
            <label>Speed: <span id="rate-val">${Number(state.voiceRate).toFixed(1)}</span>x</label>
            <div style="display:flex; align-items:center;">
                <span style="font-size:1.2rem;">ğŸ¢</span>
                <input type="range" min="0.5" max="2.0" step="0.1" value="${state.voiceRate}" 
                    oninput="state.voiceRate=parseFloat(this.value); localStorage.setItem('le_voice_rate', this.value); document.getElementById('rate-val').innerText=Number(this.value).toFixed(1);">
                <span style="font-size:1.2rem;">ğŸ‡</span>
            </div>
        </div>
        
        <button class="btn-outline" onclick="if(confirm('æœ¬å½“ã«ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){localStorage.removeItem('le_data'); location.reload();}" style="margin-top:30px; border-color:var(--danger); color:var(--danger);">âš ï¸ Reset All Data</button>
    </div>`;
    
    setTimeout(updatePrompt, 50);
}

function updateTestBadge() {
    let count = 0, now = Date.now();
    state.data.forEach(d => {
        const check = s => { if(s && s.tested_in_m2 && s.next_review <= now) count++; };
        check(d.commute_content.stats);
        if(d.home_content.drills) d.home_content.drills.forEach(dr => check(dr.stats));
    });
    const badge = document.getElementById('test-badge');
    if(badge) {
        if(count > 0) { badge.innerText = count; badge.classList.remove('hidden'); }
        else badge.classList.add('hidden');
    }
}

init();
</script>
</body>
</html>
